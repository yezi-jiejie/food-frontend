<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>食品安全预警与食品管理系统 - 管理员</title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", Arial, sans-serif; }
        body { background-color: #f5f7fa; color: #333; }
        .app-container { min-height: 100vh; display: flex; flex-direction: column; }
        .header { background: linear-gradient(135deg, #409EFF 0%, #64b5f6 100%); color: white; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; height: 70px; }
        .logo-container { display: flex; align-items: center; }
        .custom-logo { height: 45px; width: auto; margin-right: 12px; border-radius: 4px; }
        .logo-text { font-size: 20px; font-weight: bold; }
        .main-content { display: flex; flex: 1; }
        .sidebar { width: 220px; background-color: #304156; color: #fff; height: calc(100vh - 70px); overflow-y: auto; }
        .content { flex: 1; padding: 20px; overflow-y: auto; height: calc(100vh - 70px); }
        .dashboard-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .card { background: white; border-radius: 4px; box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1); overflow: hidden; }
        .card-header { padding: 15px 20px; border-bottom: 1px solid #ebeef5; font-size: 16px; font-weight: bold; color: #409EFF; }
        .card-body { padding: 20px; }
        .food-item { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid #ebeef5; }
        .food-img { width: 60px; height: 60px; border-radius: 4px; object-fit: cover; margin-right: 15px; }
        .food-info { flex: 1; }
        .food-name { font-weight: bold; margin-bottom: 5px; }
        .food-desc { color: #909399; font-size: 13px; }
        .warning-tag { margin-left: 10px; }
        .stats-item { text-align: center; padding: 15px; }
        .stats-value { font-size: 24px; font-weight: bold; color: #409EFF; margin-bottom: 5px; }
        .stats-label { color: #909399; }
        .login-container { display: flex; justify-content: center; align-items: center; height: 100vh; background: linear-gradient(135deg, #409EFF 0%, #64b5f6 100%); }
        .login-form { width: 400px; padding: 30px; background: white; border-radius: 8px; box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.2); }
        .login-title { text-align: center; margin-bottom: 30px; color: #409EFF; font-size: 24px; font-weight: bold; }
        .warning-level-high { color: #F56C6C; font-weight: bold; }
        .warning-level-medium { color: #E6A23C; font-weight: bold; }
        .warning-level-low { color: #67C23A; font-weight: bold; }
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .health-metrics { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .health-metric { background: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 12px; }
        .health-metric strong { color: #409EFF; }
        .switch-user-link { color: #409EFF; font-weight: bold; cursor: pointer; padding: 10px; text-align: center; border-top: 1px solid #606266; margin-top: 10px; }
    </style>
</head>
<body>
    <div id="app">
        <div class="login-container" v-if="isLoginPage">
            <div class="login-form">
                <div class="login-title">食品安全预警与食品管理系统</div>
                <el-form :model="loginForm" :rules="loginRules" ref="loginForm" label-width="80px">
                    <el-form-item label="用户名" prop="username">
                        <el-input v-model="loginForm.username" placeholder="请输入管理员账号"></el-input>
                    </el-form-item>
                    <el-form-item label="密码" prop="password">
                        <el-input type="password" v-model="loginForm.password" placeholder="请输入密码"></el-input>
                    </el-form-item>
                    <el-form-item>
                        <el-button type="primary" @click="handleLogin" style="width: 100%;">登录</el-button>
                    </el-form-item>
                </el-form>
            </div>
        </div>
        
        <div class="app-container" v-else>
            <header class="header">
                <div class="logo-container">
                    <img src="picture/logo.png" class="custom-logo" alt="Logo" onerror="this.style.display='none'">
                    <span class="logo-text">食品安全预警与食品管理系统 - 管理员</span>
                </div>
                <div>
                    <el-button type="text" icon="el-icon-user" style="color: white;">{{ currentUser.username }}</el-button>
                    <el-button type="text" icon="el-icon-switch-button" style="color: white;" @click="handleLogout">退出</el-button>
                </div>
            </header>
            
            <div class="main-content">
                <aside class="sidebar">
                    <el-menu default-active="dashboard" class="el-menu-vertical-demo" background-color="#304156" text-color="#bfcbd9" active-text-color="#409EFF">
                        <el-menu-item index="dashboard" @click="activeMenu = 'dashboard'">
                            <i class="el-icon-data-line"></i><span>管理仪表盘</span>
                        </el-menu-item>
                        <el-menu-item index="foods" @click="activeMenu = 'foods'">
                            <i class="el-icon-notebook-2"></i><span>食品管理</span>
                        </el-menu-item>
                        <el-menu-item index="warnings" @click="activeMenu = 'warnings'">
                            <i class="el-icon-warning-outline"></i><span>安全预警管理</span>
                        </el-menu-item>
                        <el-menu-item index="users" @click="activeMenu = 'users'">
                            <i class="el-icon-user"></i><span>用户管理</span>
                        </el-menu-item>
                    </el-menu>
                    <div class="switch-user-link" @click="switchToUserInterface">
                        <i class="el-icon-s-custom"></i> 切换到用户界面
                    </div>
                </aside>
                
                <main class="content">
                    <div v-if="activeMenu === 'dashboard'">
                        <div class="dashboard-header">
                            <div><h2 style="margin: 0;">管理仪表盘</h2><p class="el-text--secondary">系统概览与统计数据</p></div>
                            <el-date-picker v-model="viewDate" type="date" placeholder="选择日期" value-format="yyyy-MM-dd" style="width: 160px;"></el-date-picker>
                        </div>
                        
                        <div class="dashboard-cards">
                            <div class="card">
                                <div class="card-header"><span>系统统计</span></div>
                                <div class="card-body">
                                    <div style="display: flex; justify-content: space-around; margin-bottom: 20px;">
                                        <div class="stats-item"><div class="stats-value">{{ foodDatabase.length }}</div><div class="stats-label">食品数量</div></div>
                                        <div class="stats-item"><div class="stats-value">{{ foodWarnings.length }}</div><div class="stats-label">预警数量</div></div>
                                        <div class="stats-item"><div class="stats-value">{{ userCount }}</div><div class="stats-label">用户数量</div></div>
                                    </div>
                                    <div class="health-metrics">
                                        <div class="health-metric"><strong>高风险预警:</strong> {{ getWarningsByLevel('high').length }} 条</div>
                                        <div class="health-metric"><strong>中风险预警:</strong> {{ getWarningsByLevel('medium').length }} 条</div>
                                        <div class="health-metric"><strong>低风险预警:</strong> {{ getWarningsByLevel('low').length }} 条</div>
                                        <div class="health-metric"><strong>今日新增:</strong> {{ todayNewWarnings }} 条</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header"><span>最近预警</span><el-badge :value="foodWarnings.length" class="item"></el-badge></div>
                                <div class="card-body">
                                    <div class="food-item" v-for="warning in recentFoodWarnings" :key="warning.id">
                                        <img class="food-img" :src="warning.imageUrl || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRTVFNUU1Ii8+CjxwYXRoIGQ9Ik0zMCAzNUMzMy44NjYgMzUgMzcgMzEuODY2IDM3IDI4QzM3IDI0LjEzNCAzMy44NjYgMjEgMzAgMjFDMjYuMTM0IDIxIDIzIDI0LjEzNCAyMyAyOEMyMyAzMS44NjYgMjYuMTM0IDM1IDMwIDM1Wk0zMCAxOUMzMi4yMDUgMTkgMzQgMTcuMjA1IDM0IDE1QzM0IDEyLjc5NSAzMi4yMDUgMTEgMzAgMTFDMjcuNzk1IDExIDI2IDEyLjc5NSAyNiAxNUMyNiAxNy4yMDUgMjcuNzk1IDE5IDMwIDE5WiIgZmlsbD0iIzk5OTk5OSIvPgo8L3N2Zz4K'" :alt="warning.foodName">
                                        <div class="food-info">
                                            <div class="food-name">{{ warning.foodName }} <el-tag class="warning-tag" :type="getWarningTagType(warning.riskLevel)" size="mini">{{ warning.riskType }}</el-tag></div>
                                            <div class="food-desc">{{ warning.description }}</div>
                                            <div style="margin-top: 5px; font-size: 12px; color: #F56C6C;"><i class="el-icon-warning"></i> 预警级别: <span :class="'warning-level-' + warning.riskLevel">{{ getWarningLevelText(warning.riskLevel) }}</span> | 发布时间: {{ warning.publishDate }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header"><span>快速操作</span></div>
                                <div class="card-body">
                                    <el-button type="primary" icon="el-icon-plus" @click="activeMenu = 'foods'; showAddFoodDialog()" style="width: 100%; margin-bottom: 10px;">添加新食品</el-button>
                                    <el-button type="warning" icon="el-icon-warning" @click="activeMenu = 'warnings'; showAddWarningDialog()" style="width: 100%; margin-bottom: 10px;">发布安全预警</el-button>
                                    <el-button type="success" icon="el-icon-user" @click="activeMenu = 'users'" style="width: 100%;">管理用户</el-button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div v-if="activeMenu === 'foods'">
                        <div class="dashboard-header">
                            <h2 style="margin: 0;">食品管理</h2>
                            <el-button type="primary" icon="el-icon-plus" @click="showAddFoodDialog">添加食品</el-button>
                        </div>
                        <el-table :data="foodDatabase" style="width: 100%; margin-top: 20px;">
                            <el-table-column prop="name" label="食品名称"></el-table-column>
                            <el-table-column prop="calories" label="热量(cal/100g)" width="120"></el-table-column>
                            <el-table-column prop="protein" label="蛋白质(g)" width="100"></el-table-column>
                            <el-table-column prop="fat" label="脂肪(g)" width="100"></el-table-column>
                            <el-table-column prop="carbs" label="碳水(g)" width="100"></el-table-column>
                            <el-table-column label="操作" width="180">
                                <template slot-scope="scope">
                                    <el-button size="mini" @click="editFood(scope.row)">编辑</el-button>
                                    <el-button size="mini" type="danger" @click="deleteFood(scope.row)">删除</el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                        
                        <el-dialog :title="foodDialogTitle" :visible.sync="foodDialogVisible" width="600px">
                            <el-form :model="foodForm" :rules="foodRules" ref="foodForm">
                                <el-form-item label="食品名称" prop="name" label-width="80px"><el-input v-model="foodForm.name"></el-input></el-form-item>
                                <el-form-item label="热量" prop="calories" label-width="80px"><el-input-number v-model="foodForm.calories" :min="0" :max="1000" style="width: 100%;"><template slot="append">cal/100g</template></el-input-number></el-form-item>
                                <el-form-item label="蛋白质" prop="protein" label-width="80px"><el-input-number v-model="foodForm.protein" :min="0" :max="100" :step="0.1" style="width: 100%;"><template slot="append">g/100g</template></el-input-number></el-form-item>
                                <el-form-item label="脂肪" prop="fat" label-width="80px"><el-input-number v-model="foodForm.fat" :min="0" :max="100" :step="0.1" style="width: 100%;"><template slot="append">g/100g</template></el-input-number></el-form-item>
                                <el-form-item label="碳水化合物" prop="carbs" label-width="80px"><el-input-number v-model="foodForm.carbs" :min="0" :max="100" :step="0.1" style="width: 100%;"><template slot="append">g/100g</template></el-input-number></el-form-item>
                                <el-form-item label="图片URL" prop="imageUrl" label-width="80px"><el-input v-model="foodForm.imageUrl"></el-input></el-form-item>
                            </el-form>
                            <div slot="footer"><el-button @click="foodDialogVisible = false">取消</el-button><el-button type="primary" @click="saveFood">确定</el-button></div>
                        </el-dialog>
                    </div>
                    
                    <div v-if="activeMenu === 'warnings'">
                        <div class="dashboard-header">
                            <h2 style="margin: 0;">安全预警管理</h2>
                            <el-button type="warning" icon="el-icon-plus" @click="showAddWarningDialog">发布预警</el-button>
                        </div>
                        <el-table :data="foodWarnings" style="width: 100%; margin-top: 20px;">
                            <el-table-column prop="foodName" label="食品名称"></el-table-column>
                            <el-table-column prop="riskType" label="风险类型" width="120"></el-table-column>
                            <el-table-column label="风险级别" width="100">
                                <template slot-scope="scope"><el-tag :type="getWarningTagType(scope.row.riskLevel)" size="mini">{{ getWarningLevelText(scope.row.riskLevel) }}</el-tag></template>
                            </el-table-column>
                            <el-table-column prop="description" label="描述"></el-table-column>
                            <el-table-column prop="publishDate" label="发布日期" width="120"></el-table-column>
                            <el-table-column label="操作" width="180">
                                <template slot-scope="scope">
                                    <el-button size="mini" @click="editWarning(scope.row)">编辑</el-button>
                                    <el-button size="mini" type="danger" @click="deleteWarning(scope.row)">删除</el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                        
                        <el-dialog :title="warningDialogTitle" :visible.sync="warningDialogVisible" width="600px">
                            <el-form :model="warningForm" :rules="warningRules" ref="warningForm">
                                <el-form-item label="食品名称" prop="foodName" label-width="80px"><el-input v-model="warningForm.foodName"></el-input></el-form-item>
                                <el-form-item label="风险类型" prop="riskType" label-width="80px"><el-input v-model="warningForm.riskType"></el-input></el-form-item>
                                <el-form-item label="风险级别" prop="riskLevel" label-width="80px"><el-select v-model="warningForm.riskLevel" placeholder="请选择风险级别" style="width: 100%;"><el-option label="高风险" value="high"></el-option><el-option label="中风险" value="medium"></el-option><el-option label="低风险" value="low"></el-option></el-select></el-form-item>
                                <el-form-item label="描述" prop="description" label-width="80px"><el-input type="textarea" v-model="warningForm.description" :rows="4"></el-input></el-form-item>
                                <el-form-item label="图片URL" prop="imageUrl" label-width="80px"><el-input v-model="warningForm.imageUrl"></el-input></el-form-item>
                                <el-form-item label="发布日期" prop="publishDate" label-width="80px"><el-date-picker v-model="warningForm.publishDate" type="date" placeholder="选择日期" style="width: 100%;" value-format="yyyy-MM-dd"></el-date-picker></el-form-item>
                            </el-form>
                            <div slot="footer"><el-button @click="warningDialogVisible = false">取消</el-button><el-button type="primary" @click="saveWarning">确定</el-button></div>
                        </el-dialog>
                    </div>
                    
                    <div v-if="activeMenu === 'users'">
                        <h2>用户管理</h2><p class="el-text--secondary">管理系统用户和权限</p>
                        <el-table :data="users" style="width: 100%; margin-top: 20px;">
                            <el-table-column prop="username" label="用户名"></el-table-column>
                            <el-table-column prop="email" label="邮箱"></el-table-column>
                            <el-table-column prop="role" label="角色" width="120">
                                <template slot-scope="scope"><el-tag :type="scope.row.role === 'ADMIN' ? 'danger' : 'primary'">{{ scope.row.role === 'ADMIN' ? '管理员' : '普通用户' }}</el-tag></template>
                            </el-table-column>
                            <el-table-column prop="createdAt" label="注册时间" width="180"></el-table-column>
                            <el-table-column label="操作" width="180">
                                <template slot-scope="scope">
                                    <el-button size="mini" @click="editUser(scope.row)">编辑</el-button>
                                    <el-button size="mini" type="danger" @click="deleteUser(scope.row)">删除</el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = window.env?.VUE_APP_API_URL || 'https://food-backend-production-24e0.up.railway.app';
        
        const api = {
            async request(url, options = {}) {
                try {
                    const token = localStorage.getItem('token');
                    const headers = {
                        'Content-Type': 'application/json',
                        ...options.headers
                    };
                    if (token) headers['Authorization'] = `Bearer ${token}`;
                    
                    const response = await fetch(`${API_BASE_URL}${url}`, { headers, ...options });
                    if (!response.ok) throw new Error(`请求失败: ${response.statusText}`);
                    return await response.json();
                } catch (error) {
                    throw error;
                }
            },
            async get(url) { return this.request(url); },
            async post(url, data) { return this.request(url, { method: 'POST', body: JSON.stringify(data) }); },
            async put(url, data) { return this.request(url, { method: 'PUT', body: JSON.stringify(data) }); },
            async delete(url) { return this.request(url, { method: 'DELETE' }); }
        };

        new Vue({
            el: '#app',
            data() {
                return {
                    isLoginPage: true,
                    activeMenu: 'dashboard',
                    viewDate: new Date().toISOString().split('T')[0],
                    loginForm: { username: '', password: '' },
                    loginRules: {
                        username: [{ required: true, message: '请输入管理员账号', trigger: 'blur' }],
                        password: [{ required: true, message: '请输入密码', trigger: 'blur' }]
                    },
                    foodDatabase: [], foodWarnings: [], users: [], currentUser: null,
                    foodDialogVisible: false, foodDialogTitle: '添加食品',
                    foodForm: { id: null, name: '', calories: 0, protein: 0, fat: 0, carbs: 0, imageUrl: '' },
                    foodRules: {
                        name: [{ required: true, message: '请输入食品名称', trigger: 'blur' }],
                        calories: [{ required: true, message: '请输入热量值', trigger: 'blur' }]
                    },
                    warningDialogVisible: false, warningDialogTitle: '发布安全预警',
                    warningForm: { id: null, foodName: '', riskType: '', riskLevel: '', description: '', imageUrl: '', publishDate: '' },
                    warningRules: {
                        foodName: [{ required: true, message: '请输入食品名称', trigger: 'blur' }],
                        riskType: [{ required: true, message: '请输入风险类型', trigger: 'blur' }],
                        riskLevel: [{ required: true, message: '请选择风险级别', trigger: 'change' }],
                        description: [{ required: true, message: '请输入预警描述', trigger: 'blur' }],
                        publishDate: [{ required: true, message: '请选择发布日期', trigger: 'change' }]
                    }
                };
            },
            computed: {
                userCount() { return this.users.length; },
                recentFoodWarnings() { return this.foodWarnings.slice(0, 3); },
                todayNewWarnings() { 
                    const today = new Date().toISOString().split('T')[0];
                    return this.foodWarnings.filter(warning => warning.publishDate === today).length;
                }
            },
            async mounted() {
                const token = localStorage.getItem('token');
                const user = localStorage.getItem('user');
                if (token && user) {
                    this.currentUser = JSON.parse(user);
                    if (this.currentUser.role !== 'ADMIN') {
                        alert('无管理员权限，即将跳转到首页');
                        window.location.href = 'index.html';
                        return;
                    }
                    this.isLoginPage = false;
                    await this.loadSystemData();
                }
            },
            methods: {
                async loadSystemData() {
                    try {
                        const [foodRes, warningRes, userRes] = await Promise.all([
                            api.get('/foods'),
                            api.get('/warnings'), 
                            api.get('/users')
                        ]);
                        
                        this.foodDatabase = foodRes.data || [];
                        this.foodWarnings = warningRes.data || [];
                        this.users = userRes.data || [];
                        
                        this.$message.success('数据加载成功');
                    } catch (error) {
                        this.$message.error('数据加载失败: ' + error.message);
                    }
                },
                
                async handleLogin() {
                    this.$refs.loginForm.validate(async (valid) => {
                        if (valid) {
                            try {
                                const res = await api.post('/auth/admin/login', this.loginForm);
                                if (res.success && res.data.token) {
                                    localStorage.setItem('token', res.data.token);
                                    localStorage.setItem('user', JSON.stringify(res.data.user));
                                    this.currentUser = res.data.user;
                                    this.isLoginPage = false;
                                    await this.loadSystemData();
                                    this.$message.success('登录成功');
                                } else {
                                    this.$message.error('登录失败: ' + (res.message || '管理员账号或密码错误'));
                                }
                            } catch (error) {
                                this.$message.error('登录失败: ' + error.message);
                            }
                        }
                    });
                },
                
                handleLogout() {
                    this.$confirm('确定要退出登录吗?', '提示', { confirmButtonText: '确定', cancelButtonText: '取消', type: 'warning' })
                        .then(() => {
                            localStorage.removeItem('token');
                            localStorage.removeItem('user');
                            window.location.href = 'index.html';
                        }).catch(() => {});
                },
                
                switchToUserInterface() { window.location.href = '功能页.html'; },
                getWarningLevelText(riskLevel) { const texts = { high: '高风险', medium: '中风险', low: '低风险' }; return texts[riskLevel] || riskLevel; },
                getWarningTagType(riskLevel) { const types = { high: 'danger', medium: 'warning', low: 'success' }; return types[riskLevel] || 'info'; },
                getWarningsByLevel(riskLevel) { return this.foodWarnings.filter(warning => warning.riskLevel === riskLevel); },
                
                showAddFoodDialog() {
                    this.foodDialogTitle = '添加食品';
                    this.foodForm = { id: null, name: '', calories: 0, protein: 0, fat: 0, carbs: 0, imageUrl: '' };
                    this.foodDialogVisible = true;
                    this.$nextTick(() => { this.$refs.foodForm && this.$refs.foodForm.clearValidate(); });
                },
                
                editFood(food) {
                    this.foodDialogTitle = '编辑食品';
                    this.foodForm = { ...food };
                    this.foodDialogVisible = true;
                    this.$nextTick(() => { this.$refs.foodForm && this.$refs.foodForm.clearValidate(); });
                },
                
                async saveFood() {
                    this.$refs.foodForm.validate(async (valid) => {
                        if (valid) {
                            try {
                                let result;
                                if (this.foodForm.id) {
                                    result = await api.put(`/foods/${this.foodForm.id}`, this.foodForm);
                                    if (result.success) {
                                        const index = this.foodDatabase.findIndex(item => item.id === this.foodForm.id);
                                        this.foodDatabase.splice(index, 1, result.data);
                                        this.$message.success('更新成功');
                                    }
                                } else {
                                    result = await api.post('/foods', this.foodForm);
                                    if (result.success) {
                                        this.foodDatabase.push(result.data);
                                        this.$message.success('添加成功');
                                    }
                                }
                                this.foodDialogVisible = false;
                            } catch (error) {
                                this.$message.error('操作失败: ' + error.message);
                            }
                        }
                    });
                },
                
                async deleteFood(food) {
                    this.$confirm('确定要删除这个食品吗?', '提示', { confirmButtonText: '确定', cancelButtonText: '取消', type: 'warning' })
                        .then(async () => {
                            try {
                                const result = await api.delete(`/foods/${food.id}`);
                                if (result.success) {
                                    const index = this.foodDatabase.findIndex(item => item.id === food.id);
                                    this.foodDatabase.splice(index, 1);
                                    this.$message.success('删除成功');
                                }
                            } catch (error) {
                                this.$message.error('删除失败: ' + error.message);
                            }
                        }).catch(() => {});
                },
                
                showAddWarningDialog() {
                    this.warningDialogTitle = '发布安全预警';
                    this.warningForm = { id: null, foodName: '', riskType: '', riskLevel: '', description: '', imageUrl: '', publishDate: new Date().toISOString().split('T')[0] };
                    this.warningDialogVisible = true;
                    this.$nextTick(() => { this.$refs.warningForm && this.$refs.warningForm.clearValidate(); });
                },
                
                editWarning(warning) {
                    this.warningDialogTitle = '编辑安全预警';
                    this.warningForm = { ...warning };
                    this.warningDialogVisible = true;
                    this.$nextTick(() => { this.$refs.warningForm && this.$refs.warningForm.clearValidate(); });
                },
                
                async saveWarning() {
                    this.$refs.warningForm.validate(async (valid) => {
                        if (valid) {
                            try {
                                let result;
                                if (this.warningForm.id) {
                                    result = await api.put(`/warnings/${this.warningForm.id}`, this.warningForm);
                                    if (result.success) {
                                        const index = this.foodWarnings.findIndex(item => item.id === this.warningForm.id);
                                        this.foodWarnings.splice(index, 1, result.data);
                                        this.$message.success('更新成功');
                                    }
                                } else {
                                    result = await api.post('/warnings', this.warningForm);
                                    if (result.success) {
                                        this.foodWarnings.push(result.data);
                                        this.$message.success('添加成功');
                                    }
                                }
                                this.warningDialogVisible = false;
                            } catch (error) {
                                this.$message.error('操作失败: ' + error.message);
                            }
                        }
                    });
                },
                
                async deleteWarning(warning) {
                    this.$confirm('确定要删除这个安全预警吗?', '提示', { confirmButtonText: '确定', cancelButtonText: '取消', type: 'warning' })
                        .then(async () => {
                            try {
                                const result = await api.delete(`/warnings/${warning.id}`);
                                if (result.success) {
                                    const index = this.foodWarnings.findIndex(item => item.id === warning.id);
                                    this.foodWarnings.splice(index, 1);
                                    this.$message.success('删除成功');
                                }
                            } catch (error) {
                                this.$message.error('删除失败: ' + error.message);
                            }
                        }).catch(() => {});
                },
                
                async deleteUser(user) {
                    this.$confirm('确定要删除这个用户吗?', '提示', { confirmButtonText: '确定', cancelButtonText: '取消', type: 'warning' })
                        .then(async () => {
                            try {
                                const result = await api.delete(`/users/${user.id}`);
                                if (result.success) {
                                    const index = this.users.findIndex(item => item.id === user.id);
                                    this.users.splice(index, 1);
                                    this.$message.success('删除成功');
                                }
                            } catch (error) {
                                this.$message.error('删除失败: ' + error.message);
                            }
                        }).catch(() => {});
                }
            }
        });
    </script>
</body>

</html>


